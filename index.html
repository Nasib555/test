<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
  
  <!-- Allow embedding from any origin -->
  <meta http-equiv="Content-Security-Policy" content="frame-ancestors *" />
  <meta http-equiv="Access-Control-Allow-Origin" content="*" />
  <meta http-equiv="Access-Control-Allow-Methods" content="GET, POST, OPTIONS" />
  <meta http-equiv="Access-Control-Allow-Headers" content="*" />
  
  <title>YouTube Relay</title>
  <style>
    html, body { 
      height: 100%; 
      margin: 0; 
      padding: 0;
      background: #000; 
      overflow: hidden;
    }
    iframe { 
      width: 100%; 
      height: 100%; 
      border: 0; 
      display: block; 
    }
  </style>
</head>
<body>
  <div id="player"></div>
  
  <script>
    // Load YouTube IFrame API
    var tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    
    var player;
    
    // Get video ID from URL parameter
    function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      var results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
    
    var videoId = getUrlParameter('v');
    var autoplay = getUrlParameter('autoplay') || '1';
    var playsinline = getUrlParameter('playsinline') || '1';
    
    if (!videoId) {
      document.body.innerHTML = '<div style="color:white;text-align:center;padding-top:50px;">Missing ?v=VIDEO_ID</div>';
    }
    
    // Initialize YouTube player when API is ready
    window.onYouTubeIframeAPIReady = function() {
      if (!videoId) return;
      
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: videoId,
        host: 'https://www.youtube-nocookie.com',
        playerVars: {
          'autoplay': parseInt(autoplay),
          'playsinline': parseInt(playsinline),
          'enablejsapi': 1,
          'rel': 0,
          'modestbranding': 1,
          'controls': 1,
          'origin': location.origin
        },
        events: {
          'onReady': function(event) {
            console.log('YouTube player ready');
            if (parseInt(autoplay) === 1) {
              event.target.playVideo();
            }
          },
          'onStateChange': function(event) {
            console.log('Player state:', event.data);
          },
          'onError': function(event) {
            console.error('YouTube error:', event.data);
          }
        }
      });
    };
    
    // Listen for postMessage commands from parent (allow all origins)
    window.addEventListener('message', function(event) {
      // Accept messages from any origin for maximum compatibility
      // In production, you might want to validate event.origin
      
      if (!player || !player.playVideo) {
        console.log('Player not ready yet, command ignored');
        return;
      }
      
      var command = event.data;
      console.log('Received command from', event.origin, ':', command);
      
      try {
        switch(command.action) {
          case 'play':
            player.playVideo();
            break;
          case 'pause':
            player.pauseVideo();
            break;
          case 'toggle':
            var state = player.getPlayerState();
            if (state === 1) { // Playing
              player.pauseVideo();
            } else {
              player.playVideo();
            }
            break;
          case 'rewind':
            var currentTime = player.getCurrentTime();
            player.seekTo(Math.max(0, currentTime - (command.seconds || 10)), true);
            break;
          case 'forward':
            var currentTime = player.getCurrentTime();
            var duration = player.getDuration();
            player.seekTo(Math.min(duration, currentTime + (command.seconds || 10)), true);
            break;
        }
      } catch (error) {
        console.error('Error handling command:', error);
      }
    });
  </script>
</body>
</html>
